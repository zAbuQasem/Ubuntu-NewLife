#!/usr/bin/env bash
# cpu block: show aggregate CPU utilization only if >= 70%.
# No output (hides block) below threshold so we must NOT define a label in i3blocks.conf.
THRESH=70
STATE=/tmp/i3blocks_cpu_prev
CUR=$(grep '^cpu ' /proc/stat) || exit 0
if [[ -f $STATE ]]; then
  PREV=$(cat "$STATE")
else
  PREV=$CUR
fi
echo "$CUR" > "$STATE"
read -r _ u1 n1 s1 id1 iow1 irq1 sirq1 st1 _ _ <<<"$PREV"
read -r _ u2 n2 s2 id2 iow2 irq2 sirq2 st2 _ _ <<<"$CUR"
PT=$((u1+n1+s1+id1+iow1+irq1+sirq1+st1))
CT=$((u2+n2+s2+id2+iow2+irq2+sirq2+st2))
PIDLE=$((id1+iow1))
CIDLE=$((id2+iow2))
DT=$((CT-PT)); ((DT<=0)) && DT=1
DIDLE=$((CIDLE-PIDLE))
# Calculate percentage with one decimal
PCT=$(awk -v dt="$DT" -v di="$DIDLE" 'BEGIN{printf("%.1f", (dt-di)/dt*100)}')
# Compare using integer part
INT=${PCT%.*}
if (( INT < THRESH )); then
  exit 0
fi
echo "ï‹› ${PCT}%"
